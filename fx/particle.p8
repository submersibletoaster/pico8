pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
--
grav=0.05
drag=0.03
elast=0.75
tk=0
function _init()
  dots=newdots()
end
function _update()
  profin=stat(1)
  tk=tk+1
  
  v_grav=v3d.new({x=0,y=0,z=-grav})
  v_drag=v3d.new({x=1-drag,y=1-drag,z=1-drag})
  if btnp(❎) then
    for i=1,64 do
      dot.new(15+rnd(120),
        30+rnd(8),
        30+rnd(8),
        i%2==1 and 7 or 10      )
    end
  end
  if btnp(🅾️) then
    spritedots(32,32,80,2,2)
  end
  --if btn(🅾️) then
  --  dots:update()
  --end
  --if tk%8==0 then
    dots:update()
  --end
end


function _draw()
  cls(1)
  pal()
  palt(0,false)
  pal(0,1)
  map(0,0,0,0,32,32)
  dots:pre_draw()

  apply_pal(drk_pal)  
  dots:draw_refl()
  pal()
  dots:draw()
  
  print(#dots,10,120,7)
  profout=stat(1)-profin
  print(profout,80,120,7)
    if btn(🅾️) then
     --spr(16,32,100)
   end
end


drk_pal={
 0,0,1,1,2,1,5,6,2,4,9,3,1,1,2,5
}

function apply_pal(p)
  for i=0,15 do
    pal(i,p[i+1])
  end
end
-->8
--particle
grav=0.05
drag=0.03
elast=0.75

dots_m={
  update=function(t)
    for p in all(t) do
      p:update()
    end
  end,
  draw=function(t)
    for p in all(t) do
      p:draw()
    end
  end,
  pre_draw=function(t)
    for p in all(t) do
      p:pre_draw()
    end
  end,
  draw_refl=function(t)
    for p in all(t) do
      p:draw_refl()
    end
  end
}
local dts={}
dts.__index=dots_m
setmetatable(dts,dts)
function newdots()
  return dts
end

ease_in=25
dot_m={
update=function(t)
  t.tk+=1
  -- freeze first frame
  if tk==1 then return end
  local ease=1
  if tk<ease_in then
    ease=(tk)/ease_in
  end
  local v_ei=v3d.new({
   x=ease,y=ease,z=ease
  })
  
  if t.tk>t.l then
    del(dts,t)
    return
  end
  
  -- bounce or fall
  if t.lost~=true then
   if t.pos.z<0 then
     t.pos.z=-t.pos.z
     t.f.z=-t.f.z*elast
   end
  end 

  t.f=t.f*v_drag
  t.f+= v_grav
  
  t.pos=t.pos+(t.f*v_ei)
  

  
end,
draw=function(t)
  --line(t.pos.x,t.pos.y,
  --     t.pos.x,t.pos.y-t.pos.z,2)
  if t.lost==true then
    if pget(t.pos.x,t.pos.y-t.pos.z)==3 then
      pset(t.pos.x,
           t.pos.y-t.pos.z,
           8
      )
    end
  else
    -- shadow
    --if pget(t.pos.x,t.pos.y)~=3 then
    --  pset(t.pos.x,t.pos.y,5)
    --end
    pset(t.pos.x,
     t.pos.y-t.pos.z,
     t.c
    )
  end
  --pset(t.pos.x,t.pos.y,10)
end,
pre_draw=function(t)
  if pget(t.pos.x,t.pos.y)==3 
    and t.pos.z<0
    then
    t.lost=true
    --t.l+=50
  end
end,
draw_refl=function(t)
  --refl
  if pget(t.pos.x,t.pos.y+t.pos.z)~=3 then
    if t.lost~=true then
     pset(t.pos.x,t.pos.y+t.pos.z+1,
    t.c)
    end
  end  
end
}  
dot={}
dot.__index=dot_m
dot.new=function(l,x,y,c,f)
  local force=f or v3d.new(
    {x=(rnd(20)-10)/5,
     y=(rnd(20)-10)/5,
     z=rnd(20)/10}
  )
  local pos=v3d.new({
    x=x or rnd(128),
    y=y or rnd(128),
    z=1
  })
  local t={
   f=force,
   pos=pos,
   l=l or 100,
   tk=0,
   c=c or 7,
   lost=false
  }
  setmetatable(t,dot)
  add(dts,t)
  return t
end

function spritedots(s,x,y,sx,sy)
 sx=sx or 1
 sy=sy or 1
 local px=s%16
 local py=((s-px)/16)*8
 local d={}
 for iy=py,py+(sy*8) do  
  for ix=px,px+(sy*8) do
   local p=sget(ix,iy)
   if p~=0 then
    dot.new(50+rnd(100),
     x+ix,y+iy-8,
     p
     ,v3d.new({x=rnd(4)-2,y=rnd(2)-2,z=rnd(2)-0.5})
    )
    dot.new(25+rnd(100),
      x+ix,y+iy-6,
      p
      ,v3d.new({x=rnd(4)-2,y=rnd(2)-1,z=rnd(2)-0.5})
    )  
   end
   printh(ix..","..iy.." : "..p)
  end
 end
end
-->8
-- vec
v3d={
__add=function(a,b)
  local t={
   x=a["x"]+b["x"],
   y=a["y"]+b["y"],
   z=a["z"]+b["z"],
  }
  return v3d.new(t)
end,
__sub=function(a,b)

end,
__mul=function(a,b)
  local t={
   x=a["x"]*b["x"],
   y=a["y"]*b["y"],
   z=a["z"]*b["z"],
  }
  return v3d.new(t)

end
}
v3d.new=function(t)
  assert(type(t)=="table")
  local v={x=t.x,y=t.y,z=t.z}
  setmetatable(v,v3d)
  return v
end
__gfx__
00000000333333333333333333333333000000033000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333330333333333333330000000333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333330033333333333300000003333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333330003333333333000000033333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333330000333333330000000333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333330000033333300000003333333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333330000003333000000033333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333330000000330000000333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaaaee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aaa2222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000aaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aaaa19aaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaaa9aaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaaaaa22222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
009aaaaaa22222220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0099aaaa222eee220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999aaaaa2222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099999aaa999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099999999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009999999944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000044444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000405000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000101010105000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000101010101050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000201010101030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002010103000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000040300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000004030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
